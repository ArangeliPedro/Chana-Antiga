<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reinos em Ascensão - Combate Aprimorado</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Cinzel', serif;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            width: 900px;
            height: 700px;
            background: 
                radial-gradient(circle at 50% 50%, rgba(139, 69, 19, 0.3) 0%, transparent 50%),
                linear-gradient(180deg, #2c1810 0%, #1a0f0a 100%);
            border: 4px solid #8b4513;
            border-radius: 8px;
            box-shadow: 
                0 0 30px rgba(139, 69, 19, 0.5),
                inset 0 0 50px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
        }

        #game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(139, 69, 19, 0.1) 2px,
                    rgba(139, 69, 19, 0.1) 4px
                );
            pointer-events: none;
        }

        #ui-top {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #8b4513;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            z-index: 10;
        }

        .health-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .name {
            font-size: 14px;
            font-weight: 600;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .health-bar-container {
            width: 200px;
            height: 20px;
            background: #333;
            border: 2px solid #666;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #32cd32 0%, #228b22 100%);
            transition: width 0.3s ease-out, background 0.3s ease-out;
            border-radius: 8px;
        }

        .health-bar-fill.warning {
            background: linear-gradient(90deg, #ffa500 0%, #ff8c00 100%);
        }

        .health-bar-fill.critical {
            background: linear-gradient(90deg, #ff4500 0%, #dc143c 100%);
        }

        .hp-text {
            font-size: 12px;
            color: #fff;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .abilities-bar {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .ability-icon {
            width: 30px;
            height: 30px;
            border: 2px solid #666;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .ability-icon.ready {
            background: linear-gradient(135deg, #4169e1 0%, #1e90ff 100%);
            border-color: #00bfff;
            color: white;
        }

        .ability-icon.cooldown {
            background: #333;
            border-color: #666;
            color: #999;
        }

        .character {
            position: absolute;
            border: 3px solid;
            border-radius: 5px;
            transition: all 0.1s ease-out;
        }

        #player {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4169e1 0%, #1e90ff 100%);
            border-color: #00bfff;
            box-shadow: 0 0 15px rgba(65, 105, 225, 0.6);
        }

        #player.shielded {
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.8);
            border-color: #00ffff;
        }

        #enemy {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #8b0000 0%, #dc143c 100%);
            border-color: #ff6347;
            box-shadow: 0 0 20px rgba(220, 20, 60, 0.8);
        }

        #enemy.charging {
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.9);
            border-color: #ff00ff;
        }

        .projectile {
            position: absolute;
            border-radius: 50%;
        }

        .player-projectile {
            width: 8px;
            height: 12px;
            background: linear-gradient(180deg, #00ffff 0%, #0080ff 100%);
            border: 1px solid #00bfff;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.8);
            border-radius: 4px;
        }

        .player-charged-shot {
            width: 16px;
            height: 20px;
            background: linear-gradient(180deg, #ffd700 0%, #ff8c00 100%);
            border: 2px solid #ffff00;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
            border-radius: 6px;
        }

        .enemy-bullet {
            width: 6px;
            height: 6px;
            background: #696969;
            border: 1px solid #2f2f2f;
            box-shadow: 0 0 5px rgba(105, 105, 105, 0.6);
        }

        .enemy-knife {
            width: 8px;
            height: 16px;
            background: linear-gradient(180deg, #a0522d 0%, #8b4513 100%);
            border: 1px solid #654321;
            border-radius: 2px;
            box-shadow: 0 0 6px rgba(160, 82, 45, 0.6);
        }

        .enemy-spell {
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #9932cc 0%, #4b0082 100%);
            border: 2px solid #dda0dd;
            box-shadow: 0 0 12px rgba(153, 50, 204, 0.9);
            animation: pulse 0.5s infinite alternate;
        }

        .enemy-laser {
            width: 4px;
            height: 30px;
            background: linear-gradient(180deg, #ff0000 0%, #ff6347 100%);
            border: 1px solid #ff4500;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
            border-radius: 2px;
        }

        .enemy-homing {
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #ff1493 0%, #8b008b 100%);
            border: 2px solid #ff69b4;
            box-shadow: 0 0 8px rgba(255, 20, 147, 0.8);
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .shield-effect {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 3px solid #00ffff;
            border-radius: 50%;
            animation: shield-pulse 1s infinite;
            pointer-events: none;
        }

        @keyframes shield-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        #game-messages {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 50px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #8b4513;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .overlay h2 {
            font-size: 36px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #ffd700; }
            to { text-shadow: 0 0 30px #ffd700, 0 0 40px #ffd700; }
        }

        #countdown-timer {
            font-size: 48px;
            color: #ff4500;
            margin: 20px 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .overlay p {
            font-size: 18px;
            color: #e0e0e0;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        #restart-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: #ffd700;
            border: 3px solid #daa520;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        #restart-btn:hover {
            background: linear-gradient(135deg, #a0522d 0%, #cd853f 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.4);
        }

        #controls-info {
            position: absolute;
            top: 130px;
            left: 20px;
            right: 20px;
            text-align: center;
            font-size: 11px;
            color: #ccc;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            line-height: 1.4;
        }

        .boss-phase-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ff4500;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            animation: phase-announce 3s ease-out;
            z-index: 100;
            pointer-events: none;
        }

        @keyframes phase-announce {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="ui-top">
            <div id="player-health-display" class="health-display">
                <span class="name">Cavaleiro Errante</span>
                <div class="health-bar-container">
                    <div class="health-bar-fill" id="player-health-fill"></div>
                </div>
                <span class="hp-text" id="player-hp-text">HP: 100/100</span>
                <div class="abilities-bar">
                    <div class="ability-icon ready" id="dash-icon" title="Dash (Shift)">Shift</div>
                    <div class="ability-icon ready" id="shield-icon" title="Escudo (S)">S</div>
                    <div class="ability-icon ready" id="charge-icon" title="Tiro Carregado (Q)">?</div>
                </div>
            </div>
            <div id="enemy-health-display" class="health-display">
                <span class="name">O Véu - Fase <span id="boss-phase">1</span></span>
                <div class="health-bar-container">
                    <div class="health-bar-fill" id="enemy-health-fill"></div>
                </div>
                <span class="hp-text" id="enemy-hp-text">HP: 300/300</span>
                <div style="font-size: 10px; color: #ccc; margin-top: 5px;">
                    <span id="boss-pattern">Padrão: Básico</span>
                </div>
            </div>
        </div>

        <div id="controls-info">
            Movimento: ← → (A/D) | Atirar: Espaço | Dash: Shift | Escudo: S | Tiro Carregado: ? (segure)
            <br>O Véu tem 3 fases - cada uma mais mortal que a anterior!
        </div>

        <div id="player" class="character"></div>
        <div id="enemy" class="character"></div>

        <div id="game-messages">
            <div>Prepare-se para enfrentar O Véu!</div>
            <div style="font-size: 12px; color: #ccc;">Use suas habilidades sabiamente</div>
        </div>

        <div id="finishing-blow-screen" class="overlay" style="display: none;">
            <h2>GOLPE FINAL!</h2>
            <div id="countdown-timer">Tempo: 15s</div>
            <p>Pressione a tecla 'F' rapidamente para desferir o golpe fatal!</p>
            <p style="font-size: 14px; color: #ff4500;">Pressões necessárias: <span id="hits-needed">10</span></p>
        </div>

        <div id="game-over-screen" class="overlay" style="display: none;">
            <h2 id="final-message"></h2>
            <p id="final-stats"></p>
            <button id="restart-btn">Reiniciar Jogo</button>
        </div>
    </div>

    <script>
        // Elementos do DOM
        const gameContainer = document.getElementById('game-container');
        const playerEl = document.getElementById('player');
        const enemyEl = document.getElementById('enemy');
        const playerHealthFill = document.getElementById('player-health-fill');
        const enemyHealthFill = document.getElementById('enemy-health-fill');
        const playerHpText = document.getElementById('player-hp-text');
        const enemyHpText = document.getElementById('enemy-hp-text');
        const gameMessagesEl = document.getElementById('game-messages');
        const finishingBlowScreen = document.getElementById('finishing-blow-screen');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const gameOverScreen = document.getElementById('game-over-screen');
        const restartBtn = document.getElementById('restart-btn');
        const finalMessageEl = document.getElementById('final-message');
        const finalStatsEl = document.getElementById('final-stats');
        const bossPhaseEl = document.getElementById('boss-phase');
        const bossPatternEl = document.getElementById('boss-pattern');
        const dashIconEl = document.getElementById('dash-icon');
        const shieldIconEl = document.getElementById('shield-icon');
        const chargeIconEl = document.getElementById('charge-icon');
        const hitsNeededEl = document.getElementById('hits-needed');

        // Estado do jogo
        let gameRunning = false;
        let finishingBlowActive = false;
        let finishingBlowTimer = 0;
        let finishingBlowHits = 0;
        let gameOver = false;
        let gameStartTime = 0;
        let totalDamageDealt = 0;
        let totalDamageTaken = 0;

        // Atributos do jogador
        const player = {
            x: 425,
            y: 620,
            width: 50,
            height: 50,
            hp: 300,
            maxHp: 300,
            speed: 6,
            projectileDamage: 8,
            projectileSpeed: 10,
            shootCooldown: 150,
            lastShotTime: 0,
            // Novas habilidades
            dashCooldown: 2000,
            lastDashTime: 0,
            dashDistance: 120,
            dashDuration: 200,
            isDashing: false,
            shieldCooldown: 5000,
            lastShieldTime: 0,
            shieldDuration: 2000,
            isShielded: false,
            chargeShot: {
                isCharging: false,
                chargeTime: 0,
                maxChargeTime: 1500,
                cooldown: 3000,
                lastChargeTime: 0
            }
        };

        // Atributos do inimigo
        const enemy = {
            x: 410,
            y: 180,
            width: 80,
            height: 80,
            hp: 300,
            maxHp: 300,
            speed: 2,
            direction: 1,
            phase: 1,
            attackPattern: 'basic',
            lastAttackTime: 0,
            lastMoveTime: 0,
            specialAttackCooldown: 8000,
            lastSpecialAttack: 0,
            isCharging: false
        };

        // Arrays de projéteis
        let playerProjectiles = [];
        let enemyProjectiles = [];

        // Controle de teclas
        const keysPressed = {};

        // IDs de intervalos/animações
        let gameLoopId;
        let enemyAIIntervalId;
        let finishingBlowCountdownId;

        // Configurações de ataque por fase
        const phaseConfigs = {
            1: {
                hp: 300,
                attackInterval: 1200,
                moveInterval: 2000,
                speed: 2,
                projectileSpeed: 4,
                pattern: 'basic',
                attacks: ['bullet', 'knife']
            },
            2: {
                hp: 200,
                attackInterval: 800,
                moveInterval: 1500,
                speed: 3,
                projectileSpeed: 5,
                pattern: 'aggressive',
                attacks: ['bullet', 'knife', 'spell', 'laser']
            },
            3: {
                hp: 150,
                attackInterval: 600,
                moveInterval: 1000,
                speed: 4,
                projectileSpeed: 6,
                pattern: 'chaos',
                attacks: ['bullet', 'knife', 'spell', 'laser', 'homing']
            }
        };

        // Configurações de projéteis
        const projectileConfig = {
            bullet: { damage: 15, speed: 4, className: 'enemy-bullet' },
            knife: { damage: 20, speed: 5, className: 'enemy-knife' },
            spell: { damage: 25, speed: 3, className: 'enemy-spell' },
            laser: { damage: 30, speed: 8, className: 'enemy-laser' },
            homing: { damage: 35, speed: 3, className: 'enemy-homing', isHoming: true }
        };

        // Inicialização do jogo
        function initGame() {
            gameStartTime = Date.now();
            totalDamageDealt = 0;
            totalDamageTaken = 0;

            // Reset posições
            player.x = 425;
            player.y = 620;
            enemy.x = 410;
            enemy.y = 180;

            // Reset vida e fase
            player.hp = player.maxHp;
            enemy.hp = phaseConfigs[1].hp;
            enemy.maxHp = phaseConfigs[1].hp;
            enemy.phase = 1;
            enemy.direction = 1;

            // Reset habilidades
            player.isDashing = false;
            player.isShielded = false;
            player.chargeShot.isCharging = false;
            player.chargeShot.chargeTime = 0;

            // Limpar projéteis
            clearProjectiles();
            clearEffects();

            // Reset estado
            gameRunning = true;
            finishingBlowActive = false;
            gameOver = false;
            finishingBlowTimer = 0;
            finishingBlowHits = 0;

            // Ocultar telas
            finishingBlowScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';

            // Atualizar posições visuais
            updateCharacterPositions();
            updateUI();
            updateAbilityIcons();

            // Limpar mensagens
            showMessage('A batalha contra O Véu começou!', 'Fase 1: Despertar');

            // Iniciar loops
            startGameLoop();
            startEnemyAI();
        }

        function clearProjectiles() {
            const allProjectiles = document.querySelectorAll('.projectile');
            allProjectiles.forEach(projectile => projectile.remove());
            playerProjectiles = [];
            enemyProjectiles = [];
        }

        function clearEffects() {
            const allEffects = document.querySelectorAll('.shield-effect, .boss-phase-indicator');
            allEffects.forEach(effect => effect.remove());
        }

        function updateCharacterPositions() {
            playerEl.style.left = player.x + 'px';
            playerEl.style.top = player.y + 'px';
            enemyEl.style.left = enemy.x + 'px';
            enemyEl.style.top = enemy.y + 'px';
        }

        function startGameLoop() {
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function stopGameLoop() {
            cancelAnimationFrame(gameLoopId);
        }

        function startEnemyAI() {
            enemyAIIntervalId = setInterval(enemyAI, 100);
        }

        function stopEnemyAI() {
            clearInterval(enemyAIIntervalId);
        }

        // Game Loop principal
        function gameLoop(timestamp) {
            if (gameOver) return;

            handlePlayerMovement();
            handlePlayerAbilities();
            updateProjectiles();
            checkCollisions();
            updateUI();
            updateAbilityIcons();
            checkGameOver();

            gameLoopId = requestAnimationFrame(gameLoop);
        }

        // Controle do jogador
        function handlePlayerMovement() {
            if (player.isDashing) return;

            let newX = player.x;
            if (keysPressed['ArrowLeft'] || keysPressed['a'] || keysPressed['A']) {
                newX = Math.max(0, player.x - player.speed);
            }
            if (keysPressed['ArrowRight'] || keysPressed['d'] || keysPressed['D']) {
                newX = Math.min(gameContainer.offsetWidth - player.width, player.x + player.speed);
            }
            
            player.x = newX;
            playerEl.style.left = player.x + 'px';
        }

        function handlePlayerAbilities() {
            const currentTime = Date.now();

            // Dash
            if (keysPressed['Shift'] && currentTime - player.lastDashTime > player.dashCooldown && !player.isDashing) {
                performDash();
            }

            // Escudo
            if (keysPressed['s'] || keysPressed['S']) {
                if (currentTime - player.lastShieldTime > player.shieldCooldown && !player.isShielded) {
                    activateShield();
                }
            }

            // Tiro carregado
            if (keysPressed['q'] || keysPressed['Q']) {
                if (currentTime - player.chargeShot.lastChargeTime > player.chargeShot.cooldown && !player.chargeShot.isCharging) {
                    startChargeShot();
                }
            } else if (player.chargeShot.isCharging) {
                releaseChargeShot();
            }

            // Atualizar tiro carregado
            if (player.chargeShot.isCharging) {
                player.chargeShot.chargeTime = Math.min(player.chargeShot.maxChargeTime, 
                    player.chargeShot.chargeTime + 16);
            }
        }

        function performDash() {
            player.isDashing = true;
            player.lastDashTime = Date.now();
            
            let dashDirection = 0;
            if (keysPressed['ArrowLeft'] || keysPressed['a'] || keysPressed['A']) {
                dashDirection = -1;
            } else if (keysPressed['ArrowRight'] || keysPressed['d'] || keysPressed['D']) {
                dashDirection = 1;
            } else {
                dashDirection = Math.random() > 0.5 ? 1 : -1;
            }

            const targetX = Math.max(0, Math.min(gameContainer.offsetWidth - player.width, 
                player.x + dashDirection * player.dashDistance));
            
            const startX = player.x;
            const startTime = Date.now();
            
            function animateDash() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / player.dashDuration, 1);
                
                player.x = startX + (targetX - startX) * easeOutQuart(progress);
                playerEl.style.left = player.x + 'px';
                
                if (progress < 1) {
                    requestAnimationFrame(animateDash);
                } else {
                    player.isDashing = false;
                }
            }
            
            animateDash();
            showMessage('Dash executado!', '');
        }

        function easeOutQuart(t) {
            return 1 - Math.pow(1 - t, 4);
        }

        function activateShield() {
            player.isShielded = true;
            player.lastShieldTime = Date.now();
            playerEl.classList.add('shielded');
            
            // Criar efeito visual
            const shieldEffect = document.createElement('div');
            shieldEffect.className = 'shield-effect';
            shieldEffect.style.left = (player.x - 15) + 'px';
            shieldEffect.style.top = (player.y - 15) + 'px';
            gameContainer.appendChild(shieldEffect);
            
            setTimeout(() => {
                player.isShielded = false;
                playerEl.classList.remove('shielded');
                shieldEffect.remove();
            }, player.shieldDuration);
            
            showMessage('Escudo ativado!', '2 segundos de proteção');
        }

        function startChargeShot() {
            player.chargeShot.isCharging = true;
            player.chargeShot.chargeTime = 0;
            showMessage('Carregando tiro especial...', 'Solte Q para disparar');
        }

        function releaseChargeShot() {
            if (!player.chargeShot.isCharging) return;
            
            player.chargeShot.isCharging = false;
            player.chargeShot.lastChargeTime = Date.now();
            
            const chargePercent = player.chargeShot.chargeTime / player.chargeShot.maxChargeTime;
            const damage = Math.floor(player.projectileDamage * (10 + chargePercent * 16));
            
            const projectile = {
                x: player.x + player.width / 2 - 8,
                y: player.y,
                width: 16,
                height: 20,
                speed: player.projectileSpeed + 2,
                damage: damage,
                element: null,
                isCharged: true
            };

            const projectileEl = document.createElement('div');
            projectileEl.className = 'projectile player-charged-shot';
            projectileEl.style.left = projectile.x + 'px';
            projectileEl.style.top = projectile.y + 'px';
            gameContainer.appendChild(projectileEl);

            projectile.element = projectileEl;
            playerProjectiles.push(projectile);
            
            showMessage(`Tiro carregado! ${damage} de dano`, '');
        }

        // Tiro normal do jogador
        function playerShoot() {
            const currentTime = Date.now();
            if (currentTime - player.lastShotTime < player.shootCooldown) return;

            const projectile = {
                x: player.x + player.width / 2 - 4,
                y: player.y,
                width: 8,
                height: 12,
                speed: player.projectileSpeed,
                damage: player.projectileDamage,
                element: null,
                isCharged: false
            };

            const projectileEl = document.createElement('div');
            projectileEl.className = 'projectile player-projectile';
            projectileEl.style.left = projectile.x + 'px';
            projectileEl.style.top = projectile.y + 'px';
            gameContainer.appendChild(projectileEl);

            projectile.element = projectileEl;
            playerProjectiles.push(projectile);
            player.lastShotTime = currentTime;
        }

        // IA do inimigo
        function enemyAI() {
            if (!gameRunning || finishingBlowActive || gameOver) return;

            const currentTime = Date.now();
            const config = phaseConfigs[enemy.phase];

            // Movimento
            if (currentTime - enemy.lastMoveTime > config.moveInterval) {
                moveEnemy();
                enemy.lastMoveTime = currentTime;
            }

            // Ataques
            if (currentTime - enemy.lastAttackTime > config.attackInterval) {
                enemyAttack();
                enemy.lastAttackTime = currentTime;
            }

            // Ataque especial
            if (currentTime - enemy.lastSpecialAttack > enemy.specialAttackCooldown) {
                enemySpecialAttack();
                enemy.lastSpecialAttack = currentTime;
            }
        }

        function moveEnemy() {
            const config = phaseConfigs[enemy.phase];
            
            // Movimento horizontal
            enemy.x += enemy.direction * config.speed * 15;
            
            // Verificar limites e mudar direção
            if (enemy.x <= 0 || enemy.x >= gameContainer.offsetWidth - enemy.width) {
                enemy.direction *= -1;
                // Mover ligeiramente para baixo em fases avançadas
                if (enemy.phase > 1 && enemy.y < 300) {
                    enemy.y += 20;
                }
            }

            // Movimento especial por fase
            if (enemy.phase === 3) {
                // Fase 3: movimento errático
                if (Math.random() < 0.3) {
                    enemy.y += (Math.random() - 0.5) * 30;
                    enemy.y = Math.max(150, Math.min(350, enemy.y));
                }
            }

            enemyEl.style.left = enemy.x + 'px';
            enemyEl.style.top = enemy.y + 'px';
        }

        function enemyAttack() {
            const config = phaseConfigs[enemy.phase];
            const attacks = config.attacks;
            const attackType = attacks[Math.floor(Math.random() * attacks.length)];
            
            // Múltiplos projéteis em fases avançadas
            let projectileCount = 1;
            if (enemy.phase === 2 && Math.random() < 0.4) projectileCount = 2;
            if (enemy.phase === 3 && Math.random() < 0.6) projectileCount = 3;

            for (let i = 0; i < projectileCount; i++) {
                createEnemyProjectile(attackType, i, projectileCount);
            }

            const attackMessages = {
                bullet: 'O Véu dispara projéteis sombrios!',
                knife: 'O Véu lança lâminas cortantes!',
                spell: 'O Véu conjura magia das trevas!',
                laser: 'O Véu dispara raios de energia!',
                homing: 'O Véu lança projéteis rastreadores!'
            };
            
            if (projectileCount > 1) {
                showMessage(attackMessages[attackType], `Salva de ${projectileCount} projéteis!`);
            } else {
                showMessage(attackMessages[attackType], '');
            }
        }

        function createEnemyProjectile(attackType, index, total) {
            const config = projectileConfig[attackType];
            const phaseConfig = phaseConfigs[enemy.phase];
            
            // Calcular posição base
            let startX = enemy.x + enemy.width / 2 - 8;
            let startY = enemy.y + enemy.height;
            
            // Espalhar projéteis múltiplos
            if (total > 1) {
                const spread = 40;
                const offset = (index - (total - 1) / 2) * spread / (total - 1);
                startX += offset;
            }

            // Calcular direção (mirar no jogador para alguns tipos)
            let targetX = player.x + player.width / 2;
            let targetY = player.y + player.height / 2;
            
            let dx = targetX - startX;
            let dy = targetY - startY;
            let distance = Math.sqrt(dx * dx + dy * dy);
            
            // Normalizar direção
            if (distance > 0) {
                dx /= distance;
                dy /= distance;
            } else {
                dx = 0;
                dy = 1;
            }

            const projectile = {
                x: startX,
                y: startY,
                width: 16,
                height: 16,
                speed: config.speed + (phaseConfig.projectileSpeed - 4),
                damage: config.damage,
                element: null,
                dx: dx,
                dy: dy,
                isHoming: config.isHoming || false,
                type: attackType
            };

            const projectileEl = document.createElement('div');
            projectileEl.className = `projectile ${config.className}`;
            projectileEl.style.left = projectile.x + 'px';
            projectileEl.style.top = projectile.y + 'px';
            gameContainer.appendChild(projectileEl);

            projectile.element = projectileEl;
            enemyProjectiles.push(projectile);
        }

        function enemySpecialAttack() {
            enemy.isCharging = true;
            enemyEl.classList.add('charging');
            
            showMessage('O Véu está preparando um ataque devastador!', 'CUIDADO!');
            
            setTimeout(() => {
                if (!gameOver && gameRunning) {
                    // Ataque especial baseado na fase
                    if (enemy.phase === 1) {
                        circularAttack();
                    } else if (enemy.phase === 2) {
                        laserBarrage();
                    } else {
                        chaosStorm();
                    }
                }
                
                enemy.isCharging = false;
                enemyEl.classList.remove('charging');
            }, 2000);
        }

        function circularAttack() {
            const projectileCount = 8;
            for (let i = 0; i < projectileCount; i++) {
                const angle = (i / projectileCount) * Math.PI * 2;
                const dx = Math.cos(angle);
                const dy = Math.sin(angle);
                
                setTimeout(() => {
                    if (!gameOver && gameRunning) {
                        createDirectionalProjectile('spell', dx, dy);
                    }
                }, i * 100);
            }
            showMessage('Ataque Circular das Trevas!', '');
        }

        function laserBarrage() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    if (!gameOver && gameRunning) {
                        createEnemyProjectile('laser', 0, 1);
                    }
                }, i * 200);
            }
            showMessage('Barragem de Lasers!', '');
        }

        function chaosStorm() {
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    if (!gameOver && gameRunning) {
                        const types = ['bullet', 'knife', 'spell', 'laser', 'homing'];
                        const randomType = types[Math.floor(Math.random() * types.length)];
                        createEnemyProjectile(randomType, 0, 1);
                    }
                }, i * 150);
            }
            showMessage('TEMPESTADE DO CAOS!', 'Sobreviva!');
        }

        function createDirectionalProjectile(type, dx, dy) {
            const config = projectileConfig[type];
            const projectile = {
                x: enemy.x + enemy.width / 2 - 8,
                y: enemy.y + enemy.height / 2 - 8,
                width: 16,
                height: 16,
                speed: config.speed,
                damage: config.damage,
                element: null,
                dx: dx,
                dy: dy,
                isHoming: false,
                type: type
            };

            const projectileEl = document.createElement('div');
            projectileEl.className = `projectile ${config.className}`;
            projectileEl.style.left = projectile.x + 'px';
            projectileEl.style.top = projectile.y + 'px';
            gameContainer.appendChild(projectileEl);

            projectile.element = projectileEl;
            enemyProjectiles.push(projectile);
        }

        // Atualização de projéteis
        function updateProjectiles() {
            // Projéteis do jogador
            for (let i = playerProjectiles.length - 1; i >= 0; i--) {
                const projectile = playerProjectiles[i];
                projectile.y -= projectile.speed;
                
                if (projectile.y < -20) {
                    projectile.element.remove();
                    playerProjectiles.splice(i, 1);
                } else {
                    projectile.element.style.top = projectile.y + 'px';
                }
            }

            // Projéteis do inimigo
            for (let i = enemyProjectiles.length - 1; i >= 0; i--) {
                const projectile = enemyProjectiles[i];
                
                if (projectile.isHoming) {
                    // Projéteis rastreadores
                    const dx = (player.x + player.width / 2) - (projectile.x + projectile.width / 2);
                    const dy = (player.y + player.height / 2) - (projectile.y + projectile.height / 2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 0) {
                        projectile.dx = dx / distance;
                        projectile.dy = dy / distance;
                    }
                }
                
                projectile.x += projectile.dx * projectile.speed;
                projectile.y += projectile.dy * projectile.speed;
                
                if (projectile.y > gameContainer.offsetHeight + 20 || 
                    projectile.x < -20 || projectile.x > gameContainer.offsetWidth + 20) {
                    projectile.element.remove();
                    enemyProjectiles.splice(i, 1);
                } else {
                    projectile.element.style.left = projectile.x + 'px';
                    projectile.element.style.top = projectile.y + 'px';
                }
            }
        }

        // Detecção de colisões
        function checkCollisions() {
            // Jogador vs Projéteis do inimigo
            for (let i = enemyProjectiles.length - 1; i >= 0; i--) {
                const projectile = enemyProjectiles[i];
                if (isColliding(player, projectile)) {
                    if (!player.isShielded) {
                        const damage = projectile.damage;
                        player.hp = Math.max(0, player.hp - damage);
                        totalDamageTaken += damage;
                        showMessage(`Você foi atingido! -${damage} HP`, 'Use suas habilidades!');
                    } else {
                        showMessage('Escudo absorveu o dano!', '');
                    }
                    projectile.element.remove();
                    enemyProjectiles.splice(i, 1);
                }
            }

            // Inimigo vs Projéteis do jogador
            for (let i = playerProjectiles.length - 1; i >= 0; i--) {
                const projectile = playerProjectiles[i];
                if (isColliding(enemy, projectile)) {
                    const damage = projectile.damage;
                    enemy.hp = Math.max(0, enemy.hp - damage);
                    totalDamageDealt += damage;
                    projectile.element.remove();
                    playerProjectiles.splice(i, 1);
                    
                    if (projectile.isCharged) {
                        showMessage(`CRÍTICO! O Véu sofreu ${damage} de dano!`, 'Tiro carregado devastador!');
                    } else {
                        showMessage(`O Véu foi atingido! -${damage} HP`, '');
                    }
                    
                    // Verificar mudança de fase
                    checkPhaseTransition();
                }
            }
        }

        function checkPhaseTransition() {
            const currentConfig = phaseConfigs[enemy.phase];
            const hpPercent = enemy.hp / enemy.maxHp;
            
            if (enemy.phase === 1 && hpPercent <= 0.6) {
                transitionToPhase(2);
            } else if (enemy.phase === 2 && hpPercent <= 0.3) {
                transitionToPhase(3);
            }
        }

        function transitionToPhase(newPhase) {
            enemy.phase = newPhase;
            const config = phaseConfigs[newPhase];
            
            // Recuperar um pouco de vida na transição
            enemy.hp = Math.min(enemy.maxHp, enemy.hp + 50);
            
            // Limpar projéteis
            clearProjectiles();
            
            // Mostrar indicador de fase
            const phaseIndicator = document.createElement('div');
            phaseIndicator.className = 'boss-phase-indicator';
            phaseIndicator.textContent = `FASE ${newPhase}!`;
            gameContainer.appendChild(phaseIndicator);
            
            setTimeout(() => phaseIndicator.remove(), 3000);
            
            // Mensagens por fase
            const phaseMessages = {
                2: ['FASE 2: A Ira Desperta!', 'O Véu se torna mais agressivo!'],
                3: ['FASE 3: CAOS ABSOLUTO!', 'O poder completo do Véu foi liberado!']
            };
            
            showMessage(phaseMessages[newPhase][0], phaseMessages[newPhase][1]);
            
            // Reiniciar cooldowns especiais
            enemy.lastSpecialAttack = Date.now();
        }

        function isColliding(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // Atualização da interface
        function updateUI() {
            // Atualizar barras de vida
            const playerHpPercent = (player.hp / player.maxHp) * 100;
            const enemyHpPercent = (enemy.hp / enemy.maxHp) * 100;

            playerHealthFill.style.width = playerHpPercent + '%';
            enemyHealthFill.style.width = enemyHpPercent + '%';

            // Atualizar texto de HP
            playerHpText.textContent = `HP: ${player.hp}/${player.maxHp}`;
            enemyHpText.textContent = `HP: ${enemy.hp}/${enemy.maxHp}`;

            // Atualizar cores da barra de vida do jogador
            playerHealthFill.className = 'health-bar-fill';
            if (playerHpPercent <= 25) {
                playerHealthFill.classList.add('critical');
            } else if (playerHpPercent <= 50) {
                playerHealthFill.classList.add('warning');
            }

            // Atualizar informações do boss
            bossPhaseEl.textContent = enemy.phase;
            const patterns = { basic: 'Básico', aggressive: 'Agressivo', chaos: 'Caótico' };
            bossPatternEl.textContent = `Padrão: ${patterns[phaseConfigs[enemy.phase].pattern]}`;
        }

        function updateAbilityIcons() {
            const currentTime = Date.now();
            
            // Dash
            const dashReady = currentTime - player.lastDashTime > player.dashCooldown;
            dashIconEl.className = `ability-icon ${dashReady ? 'ready' : 'cooldown'}`;
            
            // Shield
            const shieldReady = currentTime - player.lastShieldTime > player.shieldCooldown && !player.isShielded;
            shieldIconEl.className = `ability-icon ${shieldReady ? 'ready' : 'cooldown'}`;
            
            // Charge shot
            const chargeReady = currentTime - player.chargeShot.lastChargeTime > player.chargeShot.cooldown;
            chargeIconEl.className = `ability-icon ${chargeReady ? 'ready' : 'cooldown'}`;
        }

        // Verificação de fim de jogo
        function checkGameOver() {
            if (player.hp <= 0) {
                gameOver = true;
                const gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
                finalMessageEl.textContent = 'Você Foi Derrotado!';
                finalStatsEl.textContent = `Tempo de jogo: ${gameTime}s | Fase alcançada: ${enemy.phase} | Dano causado: ${totalDamageDealt}`;
                gameOverScreen.style.display = 'flex';
                stopGameLoop();
                stopEnemyAI();
            } else if (enemy.hp <= 0 && !finishingBlowActive && !gameOver) {
                startFinishingBlow();
            }
        }

        // Golpe final
        function startFinishingBlow() {
            finishingBlowActive = true;
            stopEnemyAI();
            clearProjectiles();
            
            finishingBlowScreen.style.display = 'flex';
            finishingBlowTimer = 15;
            finishingBlowHits = 0;
            hitsNeededEl.textContent = '10';
            updateFinishingBlowTimer();
            
            finishingBlowCountdownId = setInterval(updateFinishingBlowTimer, 1000);
        }

        function updateFinishingBlowTimer() {
            countdownTimerEl.textContent = `Tempo: ${finishingBlowTimer}s`;
            finishingBlowTimer--;
            
            if (finishingBlowTimer < 0) {
                clearInterval(finishingBlowCountdownId);
                if (!gameOver) {
                    loseGame('Tempo Esgotado para o Golpe Final!');
                }
            }
        }

        function winGame() {
            gameOver = true;
            clearInterval(finishingBlowCountdownId);
            stopGameLoop();
            finishingBlowScreen.style.display = 'none';
            
            const gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
            const efficiency = Math.floor((totalDamageDealt / Math.max(totalDamageTaken, 1)) * 100);
            
            finalMessageEl.textContent = 'VITÓRIA ÉPICA! O Véu foi derrotado!';
            finalStatsEl.innerHTML = `
                Tempo total: ${gameTime}s<br>
                Dano causado: ${totalDamageDealt}<br>
                Dano recebido: ${totalDamageTaken}<br>
                Eficiência: ${efficiency}%
            `;
            gameOverScreen.style.display = 'flex';
        }

        function loseGame(message) {
            gameOver = true;
            clearInterval(finishingBlowCountdownId);
            stopGameLoop();
            finishingBlowScreen.style.display = 'none';
            
            const gameTime = Math.floor((Date.now() - gameStartTime) / 1000);
            finalMessageEl.textContent = message;
            finalStatsEl.textContent = `Tempo de jogo: ${gameTime}s | Fase alcançada: ${enemy.phase} | Dano causado: ${totalDamageDealt}`;
            gameOverScreen.style.display = 'flex';
        }

        function showMessage(primary, secondary) {
            gameMessagesEl.innerHTML = `
                <div>${primary}</div>
                ${secondary ? `<div style="font-size: 12px; color: #ccc;">${secondary}</div>` : ''}
            `;
            
            setTimeout(() => {
                if (!gameOver) {
                    gameMessagesEl.innerHTML = `
                        <div>Continue lutando!</div>
                        <div style="font-size: 12px; color: #ccc;">Use suas habilidades estrategicamente</div>
                    `;
                }
            }, 3000);
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            keysPressed[e.key] = true;
            
            if (e.key === ' ') {
                e.preventDefault();
                if (gameRunning && !finishingBlowActive && !gameOver && !player.chargeShot.isCharging) {
                    playerShoot();
                }
            }
            
            if ((e.key === 'f' || e.key === 'F') && finishingBlowActive) {
                finishingBlowHits++;
                hitsNeededEl.textContent = Math.max(0, 10 - finishingBlowHits);
                
                if (finishingBlowHits >= 10) {
                    winGame();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keysPressed[e.key] = false;
        });

        restartBtn.addEventListener('click', initGame);

        // Iniciar o jogo
        initGame();
    </script>
</body>
</html>
